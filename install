#!/bin/bash

set -e

# Function to convert bytes to human-readable format
formatted_size() {
  local bytes=$1
  local units=("B" "KB" "MB" "GB" "TB" "PB")
  local i=0

  while (( bytes >= 1024 && i < ${#units[@]} - 1 )); do
    bytes=$(( bytes / 1024 ))
    (( i++ ))
  done

  echo "${bytes} ${units[$i]}"
}

# Get all release assets
ASSETS=$(curl -s "https://api.github.com/repos/prassamin/prasmoid/releases/latest" | jq '.assets')

# Extract URLs for both binaries
NORMAL_URL=$(echo "$ASSETS" | jq -r '.[] | select(.name == "prasmoid") | .browser_download_url')
PORTABLE_URL=$(echo "$ASSETS" | jq -r '.[] | select(.name == "prasmoid-portable") | .browser_download_url')

# Get sizes
NORMAL_SIZE=$(echo "$ASSETS" | jq -r '.[] | select(.name == "prasmoid") | .size')
PORTABLE_SIZE=$(echo "$ASSETS" | jq -r '.[] | select(.name == "prasmoid-portable") | .size')

# Get URLs for checksums file
SHA256_URL=$(echo "$ASSETS" | jq -r '.[] | select(.name == "SHA256SUMS") | .browser_download_url')
if [[ -z "$SHA256_URL" ]]; then
  echo "Error: SHA256SUMS file is missing from the release assets. Cannot continue." >&2
  exit 3
fi

# Handle user input based on TTY availability
if [[ -t 0 ]]; then
  echo "Please select which version to install:"
  echo "1) Prasmoid ($(formatted_size $NORMAL_SIZE))"
  echo "2) Prasmoid-portable ($(formatted_size $PORTABLE_SIZE)) (Recommended for minimal systems e.g. Alpine, NixOS, etc.)"
  read -p "Enter your choice (1 or 2): " choice
else
  choice="${1:-1}"  # Default to 1 if no arg is passed
fi

# Validate choice
if [[ "$choice" != "1" && "$choice" != "2" ]]; then
  echo "Invalid choice! Please enter 1 or 2."
  exit 1
fi

# Select appropriate binary
if [[ "$choice" == "1" ]]; then
  DOWNLOAD_URL="$NORMAL_URL"
  BINARY_NAME="prasmoid"
else
  DOWNLOAD_URL="$PORTABLE_URL"
  BINARY_NAME="prasmoid-portable"
fi

# Download binary
echo "Downloading $BINARY_NAME..."
curl -L "$DOWNLOAD_URL" -o "$BINARY_NAME"

# Verify download
if [[ ! -f "$BINARY_NAME" ]]; then
  echo "Download failed!"
  exit 1
fi

if curl -L "$SHA256_URL" | sha256sum -c --ignore-missing --status - ; then
  echo "✓ Checksum passed"
else
  echo "✗ Checksum failed!" >&2
  exit 2
fi

chmod +x "$BINARY_NAME"

# Detect if running as root, else use sudo
if [[ "$EUID" -ne 0 ]]; then
  echo "Installing to /usr/bin using sudo..."
  sudo cp "$BINARY_NAME" /usr/bin/prasmoid
else
  echo "Installing to /usr/bin..."
  cp "$BINARY_NAME" /usr/bin/prasmoid
fi

rm "$BINARY_NAME"

# Final check
if [[ ! -f "/usr/bin/prasmoid" ]]; then
  echo "Installation failed!"
  exit 1
fi

echo "$BINARY_NAME installed successfully!"
echo "Run it anytime with: prasmoid"
