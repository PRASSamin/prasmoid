#!/bin/bash

set -e

# --- Helper Functions ---
formatted_size() {
  local bytes=$1
  local units=("B" "KB" "MB" "GB" "TB" "PB")
  local i=0

  while (( bytes >= 1024 && i < ${#units[@]} - 1 )); do
    bytes=$(( bytes / 1024 ))
    (( i++ ))
  done

  echo "${bytes} ${units[$i]}"
}
log_step() { echo -e "\033[0;36m→ $1\033[0m"; }
log_done() { echo -e "\033[0;32m✔ $1\033[0m"; }
log_fail() { echo -e "\033[0;31m✘ $1\033[0m"; exit 1; }

# Get all release assets
ASSETS=$(curl -s "https://api.github.com/repos/prassamin/prasmoid/releases/latest" | jq '.assets')

# Extract URLs for both binaries
NORMAL_URL=$(echo "$ASSETS" | jq -r '.[] | select(.name == "prasmoid") | .browser_download_url')
PORTABLE_URL=$(echo "$ASSETS" | jq -r '.[] | select(.name == "prasmoid-portable") | .browser_download_url')

# Get sizes
NORMAL_SIZE=$(echo "$ASSETS" | jq -r '.[] | select(.name == "prasmoid") | .size')
PORTABLE_SIZE=$(echo "$ASSETS" | jq -r '.[] | select(.name == "prasmoid-portable") | .size')

# Get URLs for checksums file
SHA256_URL=$(echo "$ASSETS" | jq -r '.[] | select(.name == "SHA256SUMS") | .browser_download_url')
if [[ -z "$SHA256_URL" ]]; then
  log_fail "Error: SHA256SUMS file is missing from the release assets. Cannot continue."
fi

# Handle user input based on TTY availability
if [[ -t 0 ]]; then
  echo "Please select which version to install:"
  echo "1) Prasmoid ($(formatted_size $NORMAL_SIZE))"
  echo "2) Prasmoid-portable ($(formatted_size $PORTABLE_SIZE)) (Recommended for minimal systems e.g. Alpine, NixOS, etc.)"
  read -p "Enter your choice (1 or 2): " choice
else
  choice="${1:-1}"  # Default to 1 if no arg is passed
fi

# Validate choice
if [[ "$choice" != "1" && "$choice" != "2" ]]; then
  log_fail "Invalid choice! Please enter 1 or 2."
fi

# Select appropriate binary
if [[ "$choice" == "1" ]]; then
  DOWNLOAD_URL="$NORMAL_URL"
  BINARY_NAME="prasmoid"
else
  DOWNLOAD_URL="$PORTABLE_URL"
  BINARY_NAME="prasmoid-portable"
fi

# Download binary
echo "Downloading $BINARY_NAME..."
curl -L "$DOWNLOAD_URL" -o "$BINARY_NAME"

# Verify download
if [[ ! -f "$BINARY_NAME" ]]; then
  log_fail "Download failed!"
fi

if curl -L "$SHA256_URL" | sha256sum -c --ignore-missing --status - ; then
  log_done "Checksum passed"
else
  log_fail "Checksum failed!"
fi

chmod +x "$BINARY_NAME"

# Detect if running as root, else use sudo
if [[ "$EUID" -ne 0 ]]; then
  log_step "Installing to /usr/bin using sudo..."
  sudo cp "$BINARY_NAME" /usr/bin/prasmoid
else
  log_step "Installing to /usr/bin..."
  cp "$BINARY_NAME" /usr/bin/prasmoid
fi

rm "$BINARY_NAME"

# Final check
if [[ ! -f "/usr/bin/prasmoid" ]]; then
  log_fail "Installation failed!"
fi

log_done "$BINARY_NAME installed successfully!"
echo -e "\Run it anytime with: prasmoid"
